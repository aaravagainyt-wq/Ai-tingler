<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FAZE | NEURAL CORE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: 'Courier New', monospace; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        canvas { position: fixed; top: 0; left: 0; z-index: -1; opacity: 0.2; }
        .border-scientist { border-left: 4px solid #3b82f6; background: rgba(59,130,246,0.1); }
        .border-safety { border-left: 4px solid #22c55e; background: rgba(34,197,94,0.1); }
        .border-logic { border-left: 4px solid #a855f7; background: rgba(168,85,247,0.1); }
        .glow-text { text-shadow: 0 0 10px #0f0; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <canvas id="matrix"></canvas>

    <div id="tos" class="fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-6">
        <div class="border-2 border-green-500 p-8 max-w-sm w-full bg-black text-center">
            <h2 class="text-green-500 font-bold text-xl mb-4 glow-text uppercase tracking-tighter">Safety Clearance</h2>
            <div class="text-[9px] text-zinc-500 text-left mb-6 space-y-2 h-32 overflow-y-auto p-2 border border-zinc-900">
                <p>> User will not request violence or illegal acts.</p>
                <p>> Developer is not liable for AI-generated text.</p>
                <p>> AI is restricted to scientific non-harmful research.</p>
            </div>
            <button onclick="enterSystem()" class="w-full bg-green-900 border border-green-400 py-4 font-bold uppercase text-xs hover:bg-green-500 transition-all">Accept & Initialize</button>
        </div>
    </div>

    <div id="ui" class="hidden h-full flex flex-col">
        <header class="p-4 border-b border-zinc-800 flex justify-between items-center bg-black/80 backdrop-blur">
            <h1 class="font-black italic text-lg glow-text">FAZE CORE</h1>
            <span id="stat" class="text-[9px] text-red-500 border border-red-900 px-2 py-1">SIGNAL: LOST</span>
        </header>

        <div id="feed" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-32"></div>

        <div class="p-4 border-t border-zinc-800 bg-black/90 backdrop-blur">
            <div class="flex gap-2">
                <input id="input" type="text" placeholder="SECURE TOPIC..." class="flex-1 bg-zinc-900/50 border border-zinc-800 p-3 text-sm focus:border-green-500 outline-none">
                <button id="btn" class="bg-green-600 px-6 font-bold text-xs">LINK</button>
            </div>
        </div>
    </div>

    <script>
        const SERVER = "https://lord123hh-aitewnsjdje.hf.space";
        let active = false, turn = 0, history = [];

        // Matrix Background Effect
        const c = document.getElementById('matrix');
        const ctx = c.getContext('2d');
        c.width = window.innerWidth; c.height = window.innerHeight;
        const drops = Array(100).fill(1);
        setInterval(() => {
            ctx.fillStyle="rgba(0,0,0,0.05)"; ctx.fillRect(0,0,c.width,c.height);
            ctx.fillStyle="#0F0"; ctx.font="15px monospace";
            drops.forEach((y,i) => {
                ctx.fillText(Math.floor(Math.random()*2), i*20, y);
                drops[i] = y > c.height || Math.random() > 0.98 ? 0 : y+20;
            });
        }, 50);

        function enterSystem() {
            document.getElementById('tos').style.display = 'none';
            document.getElementById('ui').classList.remove('hidden');
            ping();
        }

        async function ping() {
            try {
                const res = await fetch(SERVER);
                if (res.ok) {
                    document.getElementById('stat').innerText = "SIGNAL: STRONG";
                    document.getElementById('stat').classList.replace('text-red-500', 'text-green-500');
                }
            } catch (e) { setTimeout(ping, 5000); }
        }

        document.getElementById('btn').onclick = () => {
            if (active) { active = false; document.getElementById('btn').innerText = "LINK"; return; }
            if (!document.getElementById('input').value) return;
            active = true; document.getElementById('btn').innerText = "STOP";
            history = []; document.getElementById('feed').innerHTML = '';
            loop();
        };

        // STABLE LOOP WITH AUTO-RETRY
        async function loop() {
            if (!active) return;
            const bots = [
                { name: "SCIENTIST", b: "border-scientist", role: "Invent a non-violent futuristic tech." },
                { name: "SAFETY", b: "border-safety", role: "Check for non-harmful technical flaws." },
                { name: "LOGIC", b: "border-logic", role: "Confirm if possible." }
            ];

            const bot = bots[turn];
            const mid = `m-${Date.now()}`;
            addMsg(bot.name, "TRANSMITTING...", bot.b, mid);

            let success = false;
            let retries = 0;

            while (!success && retries < 3) {
                try {
                    const res = await fetch(`${SERVER}/chat`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ prompt: `ROLE: ${bot.name}. MISSION: ${bot.role}\nCONTEXT: ${history[history.length-1] || 'Start'}\nRULES: NO VIOLENCE/ILLEGAL.` })
                    });
                    const data = await res.json();
                    document.getElementById(mid).innerHTML = marked.parse(data.reply);
                    history.push(`${bot.name}: ${data.reply}`);
                    success = true;
                } catch (e) {
                    retries++;
                    document.getElementById(mid).innerText = `RECONNECTING (Attempt ${retries})...`;
                    await new Promise(r => setTimeout(r, 2000)); // Wait before retry
                }
            }

            if (!success) {
                document.getElementById(mid).innerText = "NEURAL LINK DROPPED. SERVER OVERLOAD.";
                active = false;
            } else {
                if (history.length > 4) history.shift();
                turn = (turn + 1) % 3;
                if (active) setTimeout(loop, 4000); // 4s delay to keep server cool
            }
        }

        function addMsg(name, text, b, id) {
            const d = document.createElement('div');
            d.className = `p-4 mb-2 bg-zinc-900/40 border-l-4 ${b} backdrop-blur-sm`;
            d.innerHTML = `<span class="text-[9px] font-bold opacity-50 tracking-widest">${name}</span><div id="${id}" class="text-sm mt-1">${marked.parse(text)}</div>`;
            document.getElementById('feed').appendChild(d);
            document.getElementById('feed').scrollTo({top: 10000, behavior: 'smooth'});
        }
    </script>
</body>
</html>
